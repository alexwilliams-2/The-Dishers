
<div class="main-container"> <%#For sticky map%>
  <div class="container">
    <div class="row">
      <div class="col-12 col-lg-4"> <%#This column should be used for filters%>
        <div class="row justify-content">
          <div class="col-sm-10 my-6">
            <div class="grid search">
              <div class="grid-body">
                <div class="row">
                  <div class="col-md-8">
                    <h2 class="grid-title"><i class="fa fa-filter"></i> Filters</h2>
                    <hr>
                    <h4>By category:</h4>
                      <div id="filter-buttons" data-controller="filter">
                        <%= button_to "All", businesses_path, method: :get, params: { category: nil }, class: 'filter-button', remote: true, data: { category: nil } %>
                      </div>
                      <div id="filter-buttons" data-controller="filter">
                        <%= button_to "Pub", businesses_path, method: :get, params: { category: 'Pub' }, class: 'filter-button', remote: true, data: { category: 'Pub' } %>
                      </div>
                      <div id="filter-buttons" data-controller="filter">
                        <%= button_to "Cafe", businesses_path, method: :get, params: { category: 'Cafe' }, class: 'filter-button', remote: true, data: { category: 'Cafe' } %>
                      </div>
                      <div id="filter-buttons" data-controller="filter">
                        <%= button_to "Restaurant", businesses_path, method: :get, params: { category: 'Restaurant' }, class: 'filter-button', remote: true, data: { category: 'Restaurant' } %>
                      </div>
                      <div id="filter-buttons" data-controller="filter">
                        <%= button_to "1 Star", businesses_path, method: :get, params: { rating: 1 }, class: 'filter-button', remote: true, data: { rating: 1 } %>
                        <%= button_to "2 Stars", businesses_path, method: :get, params: { rating: 2 }, class: 'filter-button', remote: true, data: { rating: 2 } %>
                        <%= button_to "3 Stars", businesses_path, method: :get, params: { rating: 3 }, class: 'filter-button', remote: true, data: { rating: 3 } %>
                        <%= button_to "4 Stars", businesses_path, method: :get, params: { rating: 4 }, class: 'filter-button', remote: true, data: { rating: 4 } %>
                        <%= button_to "5 Stars", businesses_path, method: :get, params: { rating: 5 }, class: 'filter-button', remote: true, data: { rating: 5 } %>
                        <%= button_to "£9-£10", businesses_path, method: :get, params: { wage: 9.00 }, class: 'filter-button', remote: true, data: { wage: 9.00 } %>
                        <%= button_to "£10-£11", businesses_path, method: :get, params: { wage: 10.00 }, class: 'filter-button', remote: true, data: { wage: 10.00 } %>
                        <%= button_to "£11-£12", businesses_path, method: :get, params: { wage: 11.00}, class: 'filter-button', remote: true, data: { wage: 11.00 } %>
                        <%= button_to "£12-£13", businesses_path, method: :get, params: { wage: 12.00}, class: 'filter-button', remote: true, data: { wage: 12.00 } %>
                      </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
        <div class="col-12 col-lg-8">
          <div class="row justify-content-center">
            <div class="col-sm-10 my-6">
              <div class="businesses-for-map">
                <% if @businesses.any? %>
                  <% @businesses.each do |business| %>
                  <% @wages = [] %>

                  <% @recommended_array = [] %>
                  <% @ratings = [] %>
                  <%# to make sure link is whole card - not just name %>
                  <%= link_to business, style: 'text-decoration: none; color: #000000' do %>
                    <div class="business-card mt-5">
                      <%= cl_image_tag business.photo.key, height: 300 %>
                      <div class="business-card-infos">
                        <div class="d-flex justify-content-between">
                          <h2> <%= business.name %> </h2>
                          <% business.reviews.each do |review| %>
                            <% @wages.push(review.wage) %>
                            <% end %>
                          <% unless business.reviews.empty? %>
                            <p> <%= "Average wage: #{number_to_currency((@wages.sum / business.reviews.length), options = {unit: "£"}) }"%> </p>
                          <% end %>
                        </div>
                        <% business.reviews.each do |review| %>
                          <% @ratings.push(review.rating) %>
                          <% @rating = (@ratings.sum / business.reviews.length).ceil %>
                        <% end %>
                        <% unless business.reviews.empty? %>
                          <% @rating.to_i.times do %>
                            <i class="fa-solid fa-star" style="color: #009eff;"></i>
                          <% end %>
                        <% end %>
                        <p> <%= business.description[0..100] %> </p>
                        <% business.reviews.each do |review| %> </p>
                          <% if review.recommended == true %>
                            <% @recommended_array.push(review) %>
                          <% end %>
                        <% end %>
                        <p> <%= "#{pluralize (@recommended_array.length), "Disher"} recommends working here" %> </p>
                      </div>
                    </div>
                    <% end %>
                  <% end %>
                <% else %>
                  <em> Sorry, no businesses found. </em>
                <% end %>
              </div>
            </div>
          </div>
        </div>
    </div>
  </div>
  <div id="map" style="width: 30%; height: 100vh;"
      data-controller="map"
      data-map-markers-value="<%= @markers.to_json %>"
      data-map-api-key-value="<%= ENV['MAPBOX_API_KEY'] %>">
  </div>
</div>
